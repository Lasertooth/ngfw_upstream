From 1d8d5e63601594d894bf5d04e259fca57a3940f8 Mon Sep 17 00:00:00 2001
From: Brett Mastbergen <bmastbergen@untangle.com>
Date: Thu, 17 May 2018 11:17:42 -0400
Subject: [PATCH 1/2] nftables Add ct id

---
 include/datatype.h                  |  2 ++
 include/linux/netfilter/nf_tables.h |  1 +
 src/ct.c                            |  2 ++
 src/datatype.c                      | 35 +++++++++++++++++++++++++++++++++++
 src/parser_bison.y                  |  1 +
 5 files changed, 41 insertions(+)

diff --git a/include/datatype.h b/include/datatype.h
index 9f127f2..93620c9 100644
--- a/include/datatype.h
+++ b/include/datatype.h
@@ -82,6 +82,7 @@ enum datatypes {
 	TYPE_DSCP,
 	TYPE_ECN,
 	TYPE_FIB_ADDR,
+	TYPE_INT32,
 	__TYPE_MAX
 };
 #define TYPE_MAX		(__TYPE_MAX - 1)
@@ -215,6 +216,7 @@ extern const struct datatype invalid_type;
 extern const struct datatype verdict_type;
 extern const struct datatype nfproto_type;
 extern const struct datatype bitmask_type;
+extern const struct datatype int_type;
 extern const struct datatype integer_type;
 extern const struct datatype string_type;
 extern const struct datatype lladdr_type;
diff --git a/include/linux/netfilter/nf_tables.h b/include/linux/netfilter/nf_tables.h
index f030e59..bba198e 100644
--- a/include/linux/netfilter/nf_tables.h
+++ b/include/linux/netfilter/nf_tables.h
@@ -863,6 +863,7 @@ enum nft_ct_keys {
 	NFT_CT_LABELS,
 	NFT_CT_PKTS,
 	NFT_CT_BYTES,
+	NFT_CT_ID,
 };
 
 /**
diff --git a/src/ct.c b/src/ct.c
index d079289..2e42434 100644
--- a/src/ct.c
+++ b/src/ct.c
@@ -232,6 +232,8 @@ static const struct ct_template ct_templates[] = {
 					      BYTEORDER_HOST_ENDIAN, 64),
 	[NFT_CT_PKTS]		= CT_TEMPLATE("packets", &integer_type,
 					      BYTEORDER_HOST_ENDIAN, 64),
+	[NFT_CT_ID]		= CT_TEMPLATE("id", &int_type,
+					      BYTEORDER_HOST_ENDIAN, 32),
 };
 
 static void ct_expr_print(const struct expr *expr)
diff --git a/src/datatype.c b/src/datatype.c
index f5f4f3a..2601d8d 100644
--- a/src/datatype.c
+++ b/src/datatype.c
@@ -48,6 +48,7 @@ static const struct datatype *datatypes[TYPE_MAX + 1] = {
 	[TYPE_ICMP_CODE]	= &icmp_code_type,
 	[TYPE_ICMPV6_CODE]	= &icmpv6_code_type,
 	[TYPE_ICMPX_CODE]	= &icmpx_code_type,
+	[TYPE_INT32]		= &int_type,
 };
 
 void datatype_register(const struct datatype *dtype)
@@ -292,6 +293,40 @@ const struct datatype bitmask_type = {
 	.basetype	= &integer_type,
 };
 
+static void int_type_print(const struct expr *expr, struct output_ctx *octx)
+{
+	int value;
+
+	mpz_export_data(&value, expr->value, BYTEORDER_BIG_ENDIAN, 4);
+	nft_print(octx, "%d", value);
+}
+
+static struct error_record *int_type_parse(const struct expr *sym,
+						     struct expr **res)
+{
+	int value;
+
+	value = atoi(sym->identifier);
+	*res = constant_expr_alloc(&sym->location, &int_type,
+				   BYTEORDER_BIG_ENDIAN, 4 * BITS_PER_BYTE,
+				   &value);
+	return NULL;
+}
+
+const struct datatype int_type = {
+	.type		= TYPE_INT32,
+	.name		= "int",
+	.desc		= "int",
+	.basefmt	= "%d",
+	.size		= 4 * BITS_PER_BYTE,
+	.byteorder	= BYTEORDER_BIG_ENDIAN,
+	.basetype	= &integer_type,
+	.print		= int_type_print,
+	.parse		= int_type_parse,
+};
+
+};
+
 static void integer_type_print(const struct expr *expr)
 {
 	const struct datatype *dtype = expr->dtype;
diff --git a/src/parser_bison.y b/src/parser_bison.y
index deaaf06..e6cfc54 100644
--- a/src/parser_bison.y
+++ b/src/parser_bison.y
@@ -2687,6 +2687,7 @@ ct_expr			: 	CT	ct_key
 ct_key			:	L3PROTOCOL	{ $$ = NFT_CT_L3PROTOCOL; }
 			|	PROTOCOL	{ $$ = NFT_CT_PROTOCOL; }
 			|	MARK		{ $$ = NFT_CT_MARK; }
+			|	ID		{ $$ = NFT_CT_ID; }
 			|	ct_key_counters
 			;
 ct_key_dir		:	SADDR		{ $$ = NFT_CT_SRC; }
-- 
2.11.0

