#! /bin/sh

set -e

exec >> /var/log/uvm/kernel-modules.log 2>&1

ourInit() {
if [ -x /usr/sbin/invoke-rc.d ] && [ ! "`readlink /usr/sbin/invoke-rc.d`" = /bin/true ] ; then
  invoke-rc.d $1 $2
else
  /etc/init.d/$1 $2
fi
}

KVERS=$(echo $DPKG_MAINTSCRIPT_PACKAGE | perl -pe 's/.+-3.2/3.2/')

date -Iseconds
echo $KVERS

DEV="plcm_drv"

# if we are running a 4.x kernel, and the
# hardcoded node exists, delelte it
if uname -r | grep '^4' && ls -al /dev/$DEV | grep -q 248 ; then
  rm /dev/$DEV
fi

# only run mknod on the 3.16 kernel
if grep -q $DEV /etc/rc.local ; then
  sed -i "s/^mknod \/dev\/$DEV c 248 0/if uname -r | grep -q \'^3\'\; then mknod \/dev\/$DEV c 248 0 ; fi/g" /etc/rc.local
fi

# load the module at boot
if ! grep -q $DEV /etc/modules ; then
  echo $DEV >> /etc/modules
fi

# the next 2 will fail during initial install
depmod -a || true
modprobe $DEV || true
#DEBHELPER#

exit 0
